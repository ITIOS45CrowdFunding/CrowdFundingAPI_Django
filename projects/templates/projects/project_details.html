{% extends 'projects/base.html' %} {% block content %}
{% load static %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <!-- Project Title -->
  <h2 class="text-3xl font-bold text-gray-800 mb-2">{{ project.title }}</h2>

  <!-- Tags -->
  <div class="flex flex-wrap gap-2 mb-4">
    {% for tag in tags %}
    <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full"
      >{{ tag.tag.name }}</span
    >
    {% empty %}
    <span class="text-gray-400">No tags</span>
    {% endfor %}
  </div>

 

  <!-- Swiper Slider -->
  <div class="swiper mySwiper w-full max-w-4xl mx-auto rounded shadow">
    <div class="swiper-wrapper">
      {% for image in images %}
      <div class="swiper-slide">
        <img src="{{ image.image.url }}" class="w-full" alt="Project Image" />
      </div>
      {% endfor %}
    </div>

    <!-- Navigation buttons -->
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>

    <!-- Pagination (optional) -->
    <div class="swiper-pagination"></div>
  </div>

  <!-- Project Description -->
  <div class="bg-white shadow p-6 rounded-lg mb-6">
    <h3 class="text-xl font-semibold mb-2">Details</h3>
    <p class="text-gray-700">{{ project.details }}</p>
  </div>

  <!-- Donation Summary -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
    <div class="bg-green-50 p-4 rounded border border-green-200">
      <h4 class="font-semibold text-green-700 mb-1">Target</h4>
      <p class="text-green-900">{{ project.target }} EGP</p>
    </div>
    <div class="bg-blue-50 p-4 rounded border border-blue-200">
      <h4 class="font-semibold text-blue-700 mb-1">Total Donations</h4>
      <p class="text-blue-900">{{ donations|length }} donations</p>
    </div>
  </div>

  <!-- Ratings Section -->
  <div class="bg-white shadow-md rounded-lg p-6 mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Project Ratings</h2>
    <div class="mb-4">
      <span class="text-lg font-semibold text-gray-700">Average Rating:</span>
      {% if avg_rating %}
        <span class="text-yellow-500 font-bold">{{ avg_rating|floatformat:1 }} / 5</span>
        {% if ratings.count > 0 %}
          <span class="text-gray-500">({{ ratings.count }} rating{{ ratings.count|pluralize }})</span>
        {% endif %}
      {% else %}
        <span class="text-gray-500 italic">No ratings yet.</span>
      {% endif %}
    </div>

    {% if ratings %}
      <ul class="space-y-3">
        {% for rating in ratings %}
          <li class="border-b border-gray-200 pb-2">
            <span class="font-medium text-gray-800">{{ rating.user.username }}</span> rated
            <span class="text-yellow-500 font-semibold">{{ rating.value }}/5</span>
            {% if rating.user == request.user %}
              <span class="text-sm text-blue-500">(Your rating)</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-500 italic">No ratings have been submitted for this project yet.</p>
    {% endif %}
  </div>

  <!-- Comment & Rating Form -->
  {% if user.is_authenticated %}
  <div class="bg-white rounded shadow p-6 mb-6">
    <h4 class="text-xl font-bold mb-4">Comments ({{ comments|length }})</h4>
  
    {% if comments %}
      {% for comment in comments %}
      <div class="border-b border-gray-200 pb-3 mb-3">
        <p class="font-semibold text-gray-800">{{ comment.user.username }}</p>
        <p class="text-gray-700 text-sm">{{ comment.text }}</p>
        {% if comment.created_at %}
          <p class="text-xs text-gray-400">{{ comment.created_at|date:"F j, Y, g:i a" }}</p>
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <p class="text-gray-500 text-sm">No comments yet.</p>
    {% endif %}
  </div>
  <div class="bg-gray-100 p-4 rounded mb-6">
    <h4 class="text-lg font-bold mb-3">Leave a Comment & Rating</h4>

    <form id="comment-form" class="space-y-4">
      {% csrf_token %}

      <!-- Textarea -->
      <textarea
        name="text"
        id="comment-text"
        rows="3"
        required
        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
        placeholder="Write your comment..."
      ></textarea>

      <!-- Star Rating -->
      <div
        id="star-rating"
        class="flex gap-1 text-2xl text-yellow-400 cursor-pointer"
      >
        {% for i in "12345" %}
        <span data-value="{{ forloop.counter }}" class="star">&#9734;</span>
        {% endfor %}
      </div>
      <input type="hidden" name="rating" id="rating-value" value="0" />

      <!-- Submit -->
      <button
        type="submit"
        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded"
      >
        Submit
      </button>
    </form>
  </div>
  {% else %}
  <div
    class="bg-yellow-100 text-yellow-800 border border-yellow-300 rounded p-4 mb-6"
  >
    <p class="text-sm font-medium">
      You must be logged in to comment and rate.
    </p>
  </div>
  {% endif %}

  <!-- Reports (visible to admin only maybe) -->
  <div class="bg-red-50 p-4 rounded border border-red-200">
    <h4 class="font-semibold text-red-700 mb-1">Reports</h4>
    <p class="text-red-900">{{ reports|length }} report(s) submitted.</p>
  </div>
</div>
<div>
  <a
    href="{% url 'projects:report_project' project.id %}"
    class="inline-block mt-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
  >
    Report Project
  </a>
</div>
{% endblock %} 

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const swiper = new Swiper(".mySwiper", {
    loop: true,
    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev",
    },
    pagination: {
      el: ".swiper-pagination",
    },
  });
  const form = document.getElementById("comment-form");
  const stars = document.querySelectorAll("#star-rating .star");
  const ratingInput = document.getElementById("rating-value");
  const commentText = document.getElementById("comment-text");

  let currentRating = 0;

  // Handle star click
  stars.forEach((star) => {
    star.addEventListener("click", function () {
      currentRating = this.dataset.value;
      console.log(currentRating);
      ratingInput.value = currentRating;

      // Highlight selected stars
      stars.forEach((s) => {
        s.innerHTML = s.dataset.value <= currentRating ? "★" : "☆";
      });
    });
  });

  // AJAX submit
  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    e.stopPropagation();
    console.log("Submitting comment...");
    
    try {
      const response = await fetch("{% url 'projects:add_comment' project.id %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          text: commentText.value,
          rating: ratingInput.value,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        alert("Comment submitted!");

        // Reset form
        commentText.value = "";
        ratingInput.value = 0;
        currentRating = 0;
        stars.forEach((s) => (s.innerHTML = "☆"));
      } else {
        alert("Something went wrong: " + (data.error || "Unknown error"));
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Network error occurred");
    }
  });
});
</script>
{% endblock %}
